<div class="mx-auto">
  <!-- Loading skeleton -->
  @if (loading()) {
    <div class="animate-pulse">
      <div class="h-4 w-48 bg-gray-200 rounded mb-4"></div>
      <div class="bg-white border border-gray-200 rounded-xl p-6 mb-6">
        <div class="flex items-center gap-2 mb-3">
          <div class="h-6 w-6 bg-gray-200 rounded"></div>
          <div class="h-5 w-32 bg-gray-200 rounded"></div>
          <div class="h-5 w-20 bg-gray-100 rounded-full ml-auto"></div>
        </div>
        <div class="h-4 w-2/3 bg-gray-200 rounded mb-2"></div>
        <div class="h-3 w-1/2 bg-gray-100 rounded mb-4"></div>
        <div class="h-3 w-full bg-gray-100 rounded"></div>
      </div>
      <div class="bg-white border border-gray-200 rounded-xl p-6 mb-6">
        <div class="h-4 w-40 bg-gray-200 rounded mb-4"></div>
        <div class="space-y-3">
          <div class="h-3 w-full bg-gray-100 rounded"></div>
          <div class="h-3 w-2/3 bg-gray-100 rounded"></div>
          <div class="h-3 w-3/4 bg-gray-100 rounded"></div>
        </div>
      </div>
      <div class="bg-white border border-gray-200 rounded-xl p-6">
        <div class="h-4 w-36 bg-gray-200 rounded mb-4"></div>
        <div class="space-y-4">
          @for (i of [1,2,3]; track i) {
            <div class="flex gap-3">
              <div class="h-6 w-6 rounded-full bg-gray-200"></div>
              <div class="flex-1">
                <div class="h-3 w-1/3 bg-gray-200 rounded mb-2"></div>
                <div class="h-3 w-1/2 bg-gray-100 rounded"></div>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Content -->
  @if (!loading() && request()) {
    <!-- Back Link -->
    <!-- <button
      class="inline-flex items-center gap-1 text-sm text-gray-500 hover:text-primary-600 transition-colors mb-4 cursor-pointer bg-transparent border-none p-0"
      (click)="navigateBack()">
      {{ backLink().label }}
    </button> -->

    <!-- Breadcrumbs -->
    <app-breadcrumbs [items]="breadcrumbs()" />

    <!-- Header Card -->
    <div class="bg-white border border-gray-200 rounded-xl p-6 mt-4">
      <!-- Top row: type badge + status -->
      <div class="flex items-start justify-between mb-3">
        <div class="flex items-center gap-2">
          <span class="text-lg">{{ entityIcon() }}</span>
          <span class="text-xs font-medium text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">
            {{ entityTypeLabel() }}
          </span>
        </div>
        <span class="text-xs font-semibold px-2.5 py-1 rounded-full" [ngClass]="statusBadge().class">
          {{ statusBadge().text }}
        </span>
      </div>

      <!-- Entity label -->
      <h1 class="text-lg font-bold text-gray-900 font-display tracking-tight mb-1">
        {{ request()!.entityLabel ?? 'Approval Request' }}
      </h1>

      <!-- Submitted by -->
      <p class="text-sm text-gray-500 mb-3">
        Submitted by
        <span class="font-medium text-gray-700">{{ request()!.requestedByUser.fullName }}</span>
        @if (request()!.requestedBy) {
          <span class="text-gray-400">({{ "request()!.requestedBy.role" }})</span>
        }
        ¬∑ {{ timeAgo() }}
      </p>

      <!-- ID strip -->
      <div class="flex flex-wrap gap-3 text-[11px] text-gray-400 border-t border-gray-100 pt-3">
        <span>Request: <span class="text-gray-500 font-mono">{{ request()!.requestId | slice:0:8 }}‚Ä¶</span></span>
        <span>Workflow: <span class="text-gray-500">{{ request()!.workflow?.workflowName }}</span></span>
        @if (request()!.workflow?.stages) {
          <span>Stages: <span class="text-gray-500">{{ request()!.workflow?.stages?.length }}</span></span>
        }
      </div>
    </div>

    <!-- Outcome Banner (only when finalized) -->
    @if (request()!.status === 'Approved' || request()!.status === 'Rejected') {
      <div class="mt-4">
        <app-outcome-banner
          [status]="request()!.status === 'Approved' ? 'Approved' : 'Rejected'"
          [approvedBy]="request()!.approvedBy"
          [approvedAt]="request()!.approvedAt"
          [rejectedBy]="request()!.rejectedBy"
          [rejectedAt]="request()!.rejectedAt"
          [rejectionReason]="request()!.rejectionReason" />
      </div>
    }

    <!-- Entity Details Snapshot Card -->
    @if (request()!.entityContext) {
      <div class="bg-white border border-gray-200 rounded-xl p-6 mt-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-semibold text-gray-900">Entity Details</h2>
          @if (getEntityRoute()) {
            <a
              [routerLink]="getEntityRoute()"
              class="text-xs text-primary-600 hover:text-primary-700 font-medium transition-colors">
              View Entity Page ‚Üí
            </a>
          }
        </div>

        <app-entity-summary
          [entityType]="request()!.entityType"
          [context]="request()!.entityContext!"
          [entityLabel]="request()!.entityLabel" />

        @if (request()!.entityContextSnapshotAt) {
          <div class="flex items-center gap-1.5 text-xs text-gray-400 mt-4 pt-3 border-t border-gray-100">
            <span>‚ÑπÔ∏è</span>
            <span>Snapshot taken at time of submission</span>
          </div>
        }
      </div>
    }

    <!-- Approval Journey -->
    <div class="bg-white border border-gray-200 rounded-xl p-6 mt-4">
      <h2 class="text-sm font-semibold text-gray-900 mb-4">Approval Journey</h2>
      <app-approval-journey
        [executions]="request()!.executions"
        [currentUserId]="currentUserId()"
        [currentStageOrder]="request()!.currentStageOrder"
        [requestedAt]="request()!.requestedAt" />
    </div>

    <!-- Action Card (only if current user is the assigned approver) -->
    @if (showActionCard()) {
      <div class="mt-4">
        <app-action-card
          [executionId]="currentExecutionId()"
          [processing]="processing()"
          (approve)="onApprove($event)"
          (reject)="onReject($event)" />
      </div>
    }

    <!-- Waiting Banner (pending but user is NOT the approver) -->
    @if (showWaitingBanner() && waitingApproverInfo()) {
      <div class="mt-4 bg-blue-50 border border-blue-200 rounded-xl px-5 py-4 flex items-center gap-3">
        <span class="text-blue-500 text-lg">‚è≥</span>
        <div>
          <p class="text-sm font-medium text-blue-800">Waiting for approval</p>
          <p class="text-xs text-blue-600 mt-0.5">
            Currently assigned to <span class="font-semibold">{{ waitingApproverInfo() }}</span>
          </p>
        </div>
      </div>
    }
  }

  <!-- Error / not found -->
  @if (!loading() && !request()) {
    <div class="text-center py-20">
      <div class="text-4xl mb-3">üîç</div>
      <h3 class="text-sm font-semibold text-gray-700">Request not found</h3>
      <p class="text-xs text-gray-500 mt-1 mb-4">The approval request could not be loaded.</p>
      <button
        class="text-sm text-primary-600 hover:text-primary-700 font-medium cursor-pointer bg-transparent border-none"
        (click)="navigateBack()">
        {{ backLink().label }}
      </button>
    </div>
  }
</div>
