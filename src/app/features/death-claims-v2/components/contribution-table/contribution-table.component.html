<!-- Filter chips + Search -->
<div class="flex items-center justify-between gap-4 mb-4">
  <div class="flex items-center gap-2">
    @for (chip of filterChips(); track chip.status) {
      <button
        class="px-3 py-1.5 rounded-full text-xs font-medium border transition-colors cursor-pointer"
        [ngClass]="{
          'bg-blue-600 text-white border-blue-600': activeFilter() === chip.status,
          'bg-white text-gray-500 border-gray-200 hover:border-blue-400 hover:text-blue-600': activeFilter() !== chip.status
        }"
        (click)="onFilterChange(chip.status)"
      >
        {{ chip.label }} ({{ chip.count }})
      </button>
    }
  </div>
  <div class="relative">
    <input
      type="text"
      placeholder="Search member..."
      class="pl-8 pr-3 py-1.5 text-xs border border-gray-200 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 w-48"
      [ngModel]="searchTerm()"
      (ngModelChange)="searchTerm.set($event)"
      (keyup.enter)="onSearchChange()"
    />
    <svg class="absolute left-2.5 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
    </svg>
  </div>
</div>

<!-- Table -->
<div class="overflow-x-auto">
  <table class="w-full text-sm">
    <thead>
      <tr class="bg-gray-50">
        <th class="text-left px-3 py-2.5 text-[11px] font-semibold text-gray-400 uppercase tracking-wider">Member</th>
        <th class="text-left px-3 py-2.5 text-[11px] font-semibold text-gray-400 uppercase tracking-wider">Agent</th>
        <th class="text-left px-3 py-2.5 text-[11px] font-semibold text-gray-400 uppercase tracking-wider">Amount</th>
        <th class="text-left px-3 py-2.5 text-[11px] font-semibold text-gray-400 uppercase tracking-wider">Method</th>
        <th class="text-left px-3 py-2.5 text-[11px] font-semibold text-gray-400 uppercase tracking-wider">Status</th>
        <th class="text-left px-3 py-2.5 text-[11px] font-semibold text-gray-400 uppercase tracking-wider">Actions</th>
      </tr>
    </thead>
    <tbody>
      @if (loading()) {
        @for (i of [1,2,3,4,5]; track i) {
          <tr>
            <td colspan="6" class="px-3 py-3">
              <div class="h-4 bg-gray-100 rounded animate-pulse"></div>
            </td>
          </tr>
        }
      } @else {
        @for (contrib of contributions().items; track contrib.contributionId) {
          <tr class="hover:bg-gray-50/50 border-b border-gray-100">
            <!-- Member -->
            <td class="px-3 py-2.5">
              <div class="flex items-center gap-2.5">
                <div class="w-7 h-7 rounded-md bg-blue-50 text-blue-600 flex items-center justify-center text-[11px] font-semibold shrink-0">
                  {{ getInitials(contrib.member ? (contrib.member.firstName + ' ' + contrib.member.lastName) : '?') }}
                </div>
                <div>
                  <div class="text-[13px] font-medium text-gray-900">
                    {{ contrib.member ? (contrib.member.firstName + ' ' + contrib.member.lastName) : '—' }}
                  </div>
                  <div class="text-[11px] text-gray-400">{{ contrib.member?.memberCode || '—' }}</div>
                </div>
              </div>
            </td>

            <!-- Agent -->
            <td class="px-3 py-2.5 text-[13px] text-gray-600">
              {{ contrib.agent ? (contrib.agent.firstName + ' ' + contrib.agent.lastName) : '—' }}
            </td>

            <!-- Amount -->
            <td class="px-3 py-2.5 text-[13px] text-gray-900 font-medium">
              OMR {{ contrib.expectedAmount | number:'1.3-3' }}
            </td>

            <!-- Method -->
            <td class="px-3 py-2.5 text-[13px] text-gray-600">
              {{ contrib.paymentMethod || '—' }}
            </td>

            <!-- Status -->
            <td class="px-3 py-2.5">
              <app-contribution-status-badge [status]="contrib.contributionStatus" />
            </td>

            <!-- Actions -->
            <td class="px-3 py-2.5">
              @if (canRecordPayment() && contrib.contributionStatus === 'Pending') {
                <div class="flex items-center gap-1">
                  <button
                    class="text-xs px-2.5 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors cursor-pointer"
                    (click)="recordPayment.emit(contrib)"
                  >
                    Record
                  </button>
                  <div class="relative group">
                    <button class="text-xs px-1.5 py-1 text-gray-400 hover:text-gray-600 cursor-pointer">
                      ···
                    </button>
                    <div class="hidden group-hover:block absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-md shadow-lg z-10 min-w-[120px]">
                      <button
                        class="w-full text-left px-3 py-2 text-xs text-red-600 hover:bg-red-50 cursor-pointer"
                        (click)="markMissed.emit(contrib)"
                      >
                        Mark Missed
                      </button>
                    </div>
                  </div>
                </div>
              }
              @if (canRecordPayment() && contrib.contributionStatus === 'Missed') {
                <button
                  class="text-xs px-2.5 py-1 border border-gray-200 text-gray-600 rounded hover:border-blue-400 hover:text-blue-600 transition-colors cursor-pointer"
                  (click)="recordPayment.emit(contrib)"
                >
                  Record Late
                </button>
              }
            </td>
          </tr>
        } @empty {
          <tr>
            <td colspan="6" class="text-center py-8 text-gray-400 text-sm">No contributions found.</td>
          </tr>
        }
      }
    </tbody>
  </table>
</div>

<!-- Pagination -->
@if (contributions().totalPages > 1) {
  <div class="flex items-center justify-between mt-4 pt-3 border-t border-gray-100">
    <span class="text-xs text-gray-400">
      Showing {{ ((currentPage() - 1) * 20) + 1 }}–{{ currentPage() * 20 > contributions().total ? contributions().total : currentPage() * 20 }} of {{ contributions().total }}
    </span>
    <div class="flex items-center gap-1">
      @for (page of [].constructor(contributions().totalPages); track $index) {
        <button
          class="w-7 h-7 rounded text-xs cursor-pointer transition-colors"
          [ngClass]="{
            'bg-blue-600 text-white': currentPage() === $index + 1,
            'text-gray-500 hover:bg-gray-100': currentPage() !== $index + 1
          }"
          (click)="onPageChange($index + 1)"
        >
          {{ $index + 1 }}
        </button>
      }
    </div>
  </div>
}
